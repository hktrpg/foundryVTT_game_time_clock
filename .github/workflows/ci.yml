name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Extract version from module.json
      id: version
      run: |
        VERSION=$(node -p "require('./module.json').version")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Module version: $VERSION"
        
    - name: Validate module.json
      run: |
        node -e "
          const module = require('./module.json');
          const required = ['id', 'title', 'description', 'version', 'compatibility'];
          const missing = required.filter(field => !module[field]);
          if (missing.length > 0) {
            console.error('Missing required fields:', missing);
            process.exit(1);
          }
          console.log('✅ module.json validation passed');
        "
        
    - name: Check file structure
      run: |
        # Check if required files exist
        if [ ! -f "index.js" ]; then
          echo "❌ index.js not found"
          exit 1
        fi
        
        if [ ! -f "README.md" ]; then
          echo "❌ README.md not found"
          exit 1
        fi
        
        if [ ! -d "langs" ]; then
          echo "❌ langs directory not found"
          exit 1
        fi
        
        echo "✅ File structure validation passed"
        
    - name: Validate language files
      run: |
        for lang_file in langs/*.json; do
          if [ -f "$lang_file" ]; then
            echo "Validating $lang_file..."
            node -e "JSON.parse(require('fs').readFileSync('$lang_file', 'utf8')); console.log('✅ $lang_file is valid JSON');"
          fi
        done
        
    - name: Lint JavaScript
      run: |
        if [ -f "package.json" ] && npm list eslint > /dev/null 2>&1; then
          npm run lint
        else
          echo "No ESLint configuration found, skipping linting"
        fi
        
    - name: Run tests
      run: |
        if [ -f "package.json" ] && npm run test > /dev/null 2>&1; then
          npm test
        else
          echo "No test script found, skipping tests"
        fi
